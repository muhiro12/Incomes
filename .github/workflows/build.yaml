name: Build
on:
  push:
    branches:
      - main
  workflow_run:
    workflows:
      - Test
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: version
        required: false
env:
  PROJECT-NAME: Incomes
jobs:
  build:
    runs-on: macos-11
    if: |
      !github.event.workflow_run ||
      github.event.workflow_run.conclusion == 'success'
    steps:

      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set ignored files
        run: |
          mkdir Incomes/Configuration/Package/Firebase/
          echo '${{ secrets.GOOGLESERVICE_BASE64 }}' | base64 -d -o Incomes/Configuration/Package/Firebase/GoogleService-Info.plist
          echo '${{ secrets.SECRET_BASE64 }}' | base64 -d -o Incomes/Configuration/Secret.swift
          echo '${{ secrets.STOREKIT_BASE64 }}' | base64 -d -o Incomes/Configuration/Package/StoreKit/StoreKitTestCertificate.cer

      - name: Update build number
        id: bump
        uses: yanamura/ios-bump-version@v1
        with:
          version: ${{ github.event.inputs.version }}

      - name: Create commit about build number
        run: |
          git add .
          git commit -m '${{ env.PROJECT-NAME }} ${{ steps.bump.outputs.version }} (${{ steps.bump.outputs.build-number }})'
          git push origin HEAD

      - name: iOS build
        uses: yukiarrr/ios-build-action@v1.4.0
        with:
          project-path: ${{ env.PROJECT-NAME }}.xcodeproj
          p12-base64: ${{ secrets.P12_BASE64 }}
          mobileprovision-base64: ${{ secrets.MOBILEPROVISION_BASE64 }}
          code-signing-identity: Apple Distribution
          team-id: ${{ secrets.TEAM_ID }}

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: 'output.ipa'
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}